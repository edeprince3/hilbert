# PYTHONPATH must include directory above plugin directory.
#     Define either externally or here, then import plugin.
sys.path.insert(0, '../../..')
import hilbert

molecule h2o {
#H 0.0 0.0 0.0
#H 0.0 0.0 1.0
         O            0.000000000000     0.000000000000    -0.068516219320
         H            0.000000000000    -0.790689573744     0.543701060715
         H            0.000000000000     0.790689573744     0.543701060715
no_reorient
nocom
symmetry c1
}

set {
  basis cc-pvdz
  scf_type df 
  df_ints_io save
  e_convergence 1e-12
  d_convergence 1e-12
} 

w = 0.265754876050
g = 0.05 / np.sqrt(2.0 * w )
#w = 1.0
#g = 0.0

set hilbert {
  maxiter 500
  n_photon_states          2
  cavity_frequency         [0.0, 0.0, $w]
  cavity_coupling_strength [0.0, 0.0, $g]
}

activate(h2o)

# KS reference
#set reference rks
#en,wfn = energy('pbe',return_wfn=True)

# HF reference (for debugging)
set reference rhf
en,wfn = energy('hf',return_wfn=True)

my_file=wfn.get_scratch_filename(180) + '.npy'
wfn.to_file(my_file)


set qed_use_relaxed_orbitals true 
set use_coherent_state_basis true
set rpa_exchange true
set scf maxiter=0
set tdscf_tda false

set guess read
set scf fail_on_maxiter=False
ehxx = energy('scf')

crpa, wfn_rpa = energy('polaritonic-rpa', ref_wfn=wfn, return_wfn=True)

ecrpa=variable("RPA_CORRELATION_ENERGY")

psi4.print_out("\n")
psi4.print_out("RPA Energies in au\n\n")
psi4.print_out("RPA correlation energy:  %20.12f\n" % (ecrpa))
psi4.print_out("HXX energy:              %20.12f\n" % (ehxx))
psi4.print_out("RPA total energy:        %20.12f\n" % (ecrpa + ehxx))

set num_roots 6
energy('polaritonic-tddft', ref_wfn=wfn)
#
#set TDSCF_STATES 4
#set tdscf_maxiter 400
#energy('td-hf')

#set reference rhf
#set ex_level = 1
#energy('detci')
